!function(e,t){void 0===e&&void 0!==window&&(e=window),"function"==typeof define&&define.amd?define("cometd",[],function(){return e.cometd=t()}):"object"==typeof module&&module.exports?module.exports=t():e.cometd=t()}(this,function(){var e,t,n=void 0;return e=this,t=function(){function me(){var c=[],u={};this.getTransportTypes=function(){return c.slice(0)},this.findTransportTypes=function(e,t,n){for(var r=[],i=0;i<c.length;++i){var o=c[i];!0===u[o].accept(e,t,n)&&r.push(o)}return r},this.negotiateTransport=function(e,t,n,r){for(var i=0;i<c.length;++i)for(var o=c[i],s=0;s<e.length;++s)if(o===e[s]){var a=u[o];if(!0===a.accept(t,n,r))return a}return null},this.add=function(e,t,n){for(var r=!1,i=0;i<c.length;++i)if(c[i]===e){r=!0;break}return r||("number"!=typeof n?c.push(e):c.splice(n,0,e),u[e]=t),!r},this.find=function(e){for(var t=0;t<c.length;++t)if(c[t]===e)return u[e];return null},this.remove=function(e){for(var t=0;t<c.length;++t)if(c[t]===e){c.splice(t,1);var n=u[e];return delete u[e],n}return null},this.clear=function(){c=[],u={}},this.reset=function(e){for(var t=0;t<c.length;++t)u[c[t]].reset(e)}}function m(){var n,r,t;this.registered=function(e,t){n=e,r=t},this.unregistered=function(){r=n=null},this._debug=function(){r._debug.apply(r,arguments)},this._mixin=function(){return r._mixin.apply(r,arguments)},this.getConfiguration=function(){return r.getConfiguration()},this.getAdvice=function(){return r.getAdvice()},this.setTimeout=function(e,t){return ve.setTimeout(r,e,t)},this.clearTimeout=function(e){ve.clearTimeout(e)},this.convertToMessages=function(t){if(ve.isString(t))try{return JSON.parse(t)}catch(e){throw this._debug("Could not convert to JSON the following string",'"'+t+'"'),new Error(e)}if(ve.isArray(t))return t;if(null==t)return[];if(t instanceof Object)return[t];throw new Error("Conversion Error "+t+", typeof "+typeof t)},this.accept=function(e,t,n){throw new Error("Abstract")},this.getType=function(){return n},this.getURL=function(){return t},this.setURL=function(e){t=e},this.send=function(e,t){throw new Error("Abstract")},this.reset=function(e){this._debug("Transport",n,"reset",e?"initial":"retry")},this.abort=function(){this._debug("Transport",n,"aborted")},this.toString=function(){return this.getType()}}var be="undefined"!=typeof window?window:{},ve={isString:function(e){return null!=e&&("string"==typeof e||e instanceof String)},isArray:function(e){return null!=e&&e instanceof Array},inArray:function(e,t){for(var n=0;n<t.length;++n)if(e===t[n])return n;return-1},setTimeout:function(t,n,e){return be.setTimeout(function(){try{t._debug("Invoking timed function",n),n()}catch(e){t._debug("Exception invoking timed function",n,e)}},e)},clearTimeout:function(e){be.clearTimeout(e)}};m.derive=function(e){function t(){}return t.prototype=e,new t};function n(){var r=new m,e=m.derive(r),i=0,o=null,s=[],a=[];function c(r,i){var e,o,s;this.transportSend(r,i),i.expired=!1,r.sync||(e=this.getConfiguration().maxNetworkDelay,o=e,!0===i.metaConnect&&(o+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",o,"ms for the response, maxNetworkDelay",e),i.timeout=(s=this).setTimeout(function(){i.expired=!0;var e="Request "+i.id+" of transport "+s.getType()+" exceeded "+o+" ms max network delay",t={reason:e},n=i.xhr;t.httpCode=s.xhrStatus(n),s.abortXHR(n),s._debug(e),s.complete(i,!1,i.metaConnect),r.onFailure(n,r.messages,t)},o))}function u(e){var t=++i,n={id:t,metaConnect:!1,envelope:e};s.length<this.getConfiguration().maxConnections-1?(s.push(n),c.call(this,e,n)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),a.push([e,n]))}function l(e,t){var n,r,i,o=ve.inArray(e,s);0<=o&&s.splice(o,1),0<a.length&&(o=a.shift(),n=o[0],r=o[1],this._debug("Transport dequeued request",r.id),t?(this.getConfiguration().autoBatch&&function(e){for(;0<a.length;){var t=a[0],n=t[0],t=t[1];if(n.url!==e.url||n.sync!==e.sync)break;a.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",t.id)}}.call(this,n),u.call(this,n),this._debug("Transport completed request",e.id,n)):(i=this).setTimeout(function(){i.complete(r,!1,r.metaConnect);var e={reason:"Previous request failed"},t=r.xhr;e.httpCode=i.xhrStatus(t),n.onFailure(t,n.messages,e)},0))}return e.complete=function(e,t,n){n?function(e){if(e=e.id,this._debug("Transport",this.getType(),"metaConnect complete, request",e),null!==o&&o.id!==e)throw new Error("Longpoll request mismatch, completing request "+e);o=null}.call(this,e):l.call(this,e,t)},e.transportSend=function(e,t){throw new Error("Abstract")},e.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&0<n.length?e.onSuccess(n):e.onFailure(t.xhr,e.messages,{httpCode:204}))},e.transportFailure=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n))},e.send=function(e,t){(t?function(e){if(null!==o)throw new Error("Concurrent metaConnect requests not allowed, request id="+o.id+" not yet completed");var t=++i;this._debug("Transport",this.getType(),"metaConnect send, request",t,"envelope",e),c.call(this,e,t={id:t,metaConnect:!0,envelope:e}),o=t}:u).call(this,e)},e.abort=function(){r.abort();for(var e=0;e<s.length;++e){var t=s[e];t&&(this._debug("Aborting request",t),this.abortXHR(t.xhr)||this.transportFailure(t.envelope,t,{reason:"abort"}))}var n=o;n&&(this._debug("Aborting metaConnect request",n),this.abortXHR(n.xhr)||this.transportFailure(n.envelope,n,{reason:"abort"})),this.reset(!0)},e.reset=function(e){r.reset(e),o=null,s=[],a=[]},e.abortXHR=function(e){if(e)try{var t=e.readyState;return e.abort(),t!==be.XMLHttpRequest.UNSENT}catch(e){this._debug(e)}return!1},e.xhrStatus=function(e){if(e)try{return e.status}catch(e){this._debug(e)}return-1},e}function ye(){var t=new n,i=m.derive(t),a=!0;return i.accept=function(e,t,n){return a||!t},i.newXMLHttpRequest=function(){return new be.XMLHttpRequest},i.xhrSend=function(e){var t=i.newXMLHttpRequest();t.context=i.context,t.withCredentials=!0,t.open("POST",e.url,!0!==e.sync);var n=e.headers;if(n)for(var r in n)n.hasOwnProperty(r)&&t.setRequestHeader(r,n[r]);return t.setRequestHeader("Content-Type","application/json;charset=UTF-8"),t.onload=function(){200===t.status?e.onSuccess(t.responseText):e.onError(t.statusText)},t.onerror=function(){e.onError(t.statusText)},t.send(e.body),t},i.transportSend=function(r,i){this._debug("Transport",this.getType(),"sending request",i.id,"envelope",r);var o=this;try{var s=!0;i.xhr=this.xhrSend({transport:this,url:r.url,sync:r.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(r.messages),onSuccess:function(e){o._debug("Transport",o.getType(),"received response",e);var t=!1;try{var n=o.convertToMessages(e);0===n.length?(a=!1,o.transportFailure(r,i,{httpCode:204})):(t=!0,o.transportSuccess(r,i,n))}catch(e){o._debug(e),t||(a=!1,(t={exception:e}).httpCode=o.xhrStatus(i.xhr),o.transportFailure(r,i,t))}},onError:function(e,t){o._debug("Transport",o.getType(),"received error",e,t),a=!1;var n={reason:e,exception:t};n.httpCode=o.xhrStatus(i.xhr),s?o.setTimeout(function(){o.transportFailure(r,i,n)},0):o.transportFailure(r,i,n)}}),s=!1}catch(e){a=!1,this.setTimeout(function(){o.transportFailure(r,i,{exception:e})},0)}},i.reset=function(e){t.reset(e),a=!0},i}function Te(){var e=new n,e=m.derive(e),o=0;function g(e,t,n){var r=this;return function(){r.transportFailure(e,t,"error",n)}}return e.accept=function(e,t,n){return!0},e.jsonpSend=function(t){var n=document.getElementsByTagName("head")[0],r=document.createElement("script"),i="_cometd_jsonp_"+o++;be[i]=function(e){n.removeChild(r),delete be[i],t.onSuccess(e)};var e=t.url;e+=e.indexOf("?")<0?"?":"&",e+="jsonp="+i,e+="&message="+encodeURIComponent(t.body),r.src=e,r.async=!0!==t.sync,r.type="application/javascript",r.onerror=function(e){t.onError("jsonp "+e.type)},n.appendChild(r)},e.transportSend=function(e,r){for(var i=this,t=0,n=e.messages.length,o=[];0<n;){var s=JSON.stringify(e.messages.slice(t,t+n)),a=e.url.length+encodeURI(s).length,s=this.getConfiguration().maxURILength;if(s<a){if(1===n){s="Bayeux message too big ("+a+" bytes, max is "+s+") for transport "+this.getType();return void this.setTimeout(g.call(this,e,r,s),0)}--n}else o.push(n),t+=n,n=e.messages.length-t}var c=e;if(1<o.length){var u=o[0];this._debug("Transport",this.getType(),"split",e.messages.length,"messages into",o.join(" + ")),(c=this._mixin(!1,{},e)).messages=e.messages.slice(0,u),c.onSuccess=e.onSuccess,c.onFailure=e.onFailure;for(var l=1;l<o.length;++l){var h=this._mixin(!1,{},e),f=u;u+=o[l],h.messages=e.messages.slice(f,u),h.onSuccess=e.onSuccess,h.onFailure=e.onFailure,this.send(h,r.metaConnect)}}this._debug("Transport",this.getType(),"sending request",r.id,"envelope",c);try{var d=!0;this.jsonpSend({transport:this,url:c.url,sync:c.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(c.messages),onSuccess:function(e){var t=!1;try{var n=i.convertToMessages(e);0===n.length?i.transportFailure(c,r,{httpCode:204}):(t=!0,i.transportSuccess(c,r,n))}catch(e){i._debug(e),t||i.transportFailure(c,r,{exception:e})}},onError:function(e,t){var n={reason:e,exception:t};d?i.setTimeout(function(){i.transportFailure(c,r,n)},0):i.transportFailure(c,r,n)}}),d=!1}catch(e){this.setTimeout(function(){i.transportFailure(c,r,{exception:e})},0)}},e}function we(){var c,n=new m,u=m.derive(n),l=!0,h=!(u.webSocketConnected=!1),f=null,d=null,b=!1,v=null;function g(e,t){e&&(this.webSocketClose(e,t.code,t.reason),this.onClose(e,t))}function p(e){return e===d||e===f}function i(e,t,n){for(var r=[],i=0;i<t.messages.length;++i){var o=t.messages[i];o.id&&r.push(o.id)}e.envelopes[r.join(",")]=[t,n],this._debug("Transport",this.getType(),"stored envelope, envelopes",e.envelopes)}function o(t){if(!d){var e=c.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",e);try{var n=c.getConfiguration().protocol;t.webSocket=n?new be.WebSocket(e,n):new be.WebSocket(e),d=t}catch(e){throw l=!1,this._debug("Exception while creating WebSocket object",e),new Error(e)}h=!1!==c.getConfiguration().stickyReconnect;var r=this,i=c.getConfiguration().connectTimeout;0<i&&(t.connectTimer=this.setTimeout(function(){c._debug("Transport",r.getType(),"timed out while connecting to URL",e,":",i,"ms"),g.call(r,t,{code:1e3,reason:"Connect Timeout"})},i));function o(e){c._debug("WebSocket onclose",t,e=e||{code:1e3},"connecting",d,"current",f),t.connectTimer&&r.clearTimeout(t.connectTimer),r.onClose(t,e)}t.webSocket.onopen=function(){c._debug("WebSocket onopen",t),t.connectTimer&&r.clearTimeout(t.connectTimer),p(t)?(d=null,f=t,u.webSocketConnected=!0,r.onOpen(t)):(c._warn("Closing extra WebSocket connection",this,"active connection",f),g.call(r,t,{code:1e3,reason:"Extra Connection"}))},t.webSocket.onclose=o,t.webSocket.onerror=function(){o({code:1e3,reason:"Error"})},t.webSocket.onmessage=function(e){c._debug("WebSocket onmessage",e,t),r.onMessage(t,e)},this._debug("Transport",this.getType(),"configured callbacks on",t)}}function s(n,r,e){var t=JSON.stringify(r.messages);n.webSocket.send(t),this._debug("Transport",this.getType(),"sent",r,"metaConnect =",e),this.onStat({tx:t.length});var t=this.getConfiguration().maxNetworkDelay,i=t;e&&(i+=this.getAdvice().timeout,b=!0);for(var o=this,s=[],a=0;a<r.messages.length;++a)!function(){var e,t=r.messages[a];t.id&&(s.push(t.id),(n.timeouts[t.id]=e={clear:function(){e.timeout&&o.clearTimeout(e.timeout),e.timeout=null},rearm:function(){e.clear(),e.timeout=o.setTimeout(function(){c._debug("Transport",o.getType(),"timing out message",t.id,"after",i,"on",n),g.call(o,n,{code:1e3,reason:"Message Timeout"})},i)}}).rearm())}();this._debug("Transport",this.getType(),"waiting at most",i,"ms for messages",s,"maxNetworkDelay",t,", timeouts:",n.timeouts)}return u.reset=function(e){n.reset(e),l=!0,e&&(u.webSocketConnected=!1),d=f=null,b=!(h=!0)},u._notifySuccess=function(e,t){e.call(this,t)},u._notifyFailure=function(e,t,n,r){e.call(this,t,n,r)},u.onOpen=function(e){var t,n,r,i=e.envelopes;for(t in this._debug("Transport",this.getType(),"opened",e,"pending messages",i),i)i.hasOwnProperty(t)&&(n=(r=i[t])[0],r=r[1],v=n.onSuccess,s.call(this,e,n,r))},u.onMessage=function(e,t){if(this._debug("Transport",this.getType(),"received websocket message",t,e),this.onStat({rx:t.data&&t.data.length||0}),this.getConfiguration().rearmNetworkDelayAfterMessage){var n=(new Date).getTime();if(!e._lastRearm||1e3<n-e._lastRearm)for(var r in e._lastRearm=n,e.timeouts)e.timeouts.hasOwnProperty(r)&&e.timeouts[r].rearm()}for(var i=!1,o=this.convertToMessages(t.data),s=[],a=0;a<o.length;++a){var c,u=o[a];(/^\/meta\//.test(u.channel)||void 0===u.data)&&u.id&&(s.push(u.id),(c=e.timeouts[u.id])&&(c.clear(),delete e.timeouts[u.id],this._debug("Transport",this.getType(),"removed timeout for message",u.id,", timeouts",e.timeouts))),"/meta/connect"===u.channel&&(b=!1),"/meta/disconnect"!==u.channel||b||(i=!0)}for(var l=!1,h=e.envelopes,f=0;f<s.length;++f){var d,r=s[f];for(d in h)if(h.hasOwnProperty(d)){var g=d.split(","),p=ve.inArray(r,g);if(0<=p){l=!0,g.splice(p,1);var m=h[d][0],p=h[d][1];delete h[d],0<g.length&&(h[g.join(",")]=[m,p]);break}}}l&&this._debug("Transport",this.getType(),"removed envelope, envelopes",h),this._notifySuccess(v,o),i&&this.webSocketClose(e,1e3,"Disconnect")},u.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t),p(e)&&(l=h&&u.webSocketConnected,f=d=null);var n,r=e.timeouts;for(n in e.timeouts={},r)r.hasOwnProperty(n)&&r[n].clear();var i,o,s,a=e.envelopes;for(i in e.envelopes={},a)a.hasOwnProperty(i)&&(o=a[i][0],a[i][1]&&(b=!1),s={websocketCode:t.code,reason:t.reason},t.exception&&(s.exception=t.exception),this._notifyFailure(o.onFailure,e,o.messages,s))},u.registered=function(e,t){n.registered(e,t),c=t},u.accept=function(e,t,n){return this._debug("Transport",this.getType(),"accept, supported:",l),l&&!!be.WebSocket&&!1!==c.websocketEnabled},u.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"metaConnect =",t),function(t,e,n){try{null===t?(i.call(this,t=d||{envelopes:{},timeouts:{}},e,n),o.call(this,t)):(i.call(this,t,e,n),s.call(this,t,e,n))}catch(e){var r=this;this.setTimeout(function(){g.call(r,t,{code:1e3,reason:"Exception",exception:e})},0)}}.call(this,f,e,t)},u.webSocketClose=function(e,t,n){try{e.webSocket&&e.webSocket.close(t,n)}catch(e){this._debug(e)}},u.abort=function(){n.abort(),g.call(this,f,{code:1e3,reason:"Abort"}),this.reset(!0)},u.onStat=function(e){},u}var f=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],d=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];return{CometD:function(e,t){var c,o,s,u=this,n=e||"default",a=!1,l=new me,r="disconnected",i=0,h=null,f=0,d=[],g=!1,p=0,m={},b=0,v=null,y=[],T={},w={},x={},k=!1,_=!1,C=0,S=0;t&&"undefined"!==t.glob&&(be=t.glob);var E,R,I={protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",maxNetworkDelay:1e4,rearmNetworkDelayAfterMessage:!1,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};function L(e,t){try{return e[t]}catch(e){return}}function A(e){return ve.isString(e)}function U(e){return null!=e&&"function"==typeof e}function q(e,t){for(var n="";0<--t&&!(e>=Math.pow(10,t));)n+="0";return n+=e}function D(e,t){var n;!be.console||U(n=be.console[e])&&(e=new Date,[].splice.call(t,0,0,q(e.getHours(),2)+":"+q(e.getMinutes(),2)+":"+q(e.getSeconds(),2)+"."+q(e.getMilliseconds(),3)),n.apply(be.console,t))}function F(e){return/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(e)}function B(e){var t;!e||(t=m[e.channel])&&t[e.id]&&(delete t[e.id],u._debug("Removed",e.listener?"listener":"subscription",e))}function O(e){e&&!e.listener&&B(e)}function M(){for(var e in m)if(m.hasOwnProperty(e)){var t=m[e];if(t)for(var n in t)t.hasOwnProperty(n)&&O(t[n])}}function N(e){r!==e&&(u._debug("Status",r,"->",e),r=e)}function P(){return"disconnecting"===r||"disconnected"===r}function j(){return""+ ++i}function H(t,e,n,r,i){try{return e.call(t,r)}catch(e){t=u.onExtensionException;if(U(t)){u._debug("Invoking extension exception handler",n,e);try{t.call(u,e,n,i,r)}catch(e){u._info("Exception during execution of extension exception handler",n,e)}}else u._info("Exception during execution of extension",n,e);return r}}function W(e,t){var n=m[e];if(n)for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i)try{i.callback.call(i.scope,t)}catch(e){r=u.onListenerException;if(U(r)){u._debug("Invoking listener exception handler",i,e);try{r.call(u,e,i,i.listener,t)}catch(e){u._info("Exception during execution of listener exception handler",i,e)}}else u._info("Exception during execution of listener",i,t,e)}}}function X(e,t){W(e,t);for(var n=e.split("/"),r=n.length-1,i=r;0<i;--i){var o=n.slice(0,i).join("/")+"/*";i===r&&W(o,t),W(o+="*",t)}}function J(){null!==v&&ve.clearTimeout(v),v=null}function Z(e,t){J();t=T.interval+t;u._debug("Function scheduled in",t,"ms, interval =",T.interval,"backoff =",b,e),v=ve.setTimeout(u,e,t)}function V(e,t,n,r){for(var i,o=0;o<t.length;++o){var s=t[o],a=s.id;h&&(s.clientId=h),null!=(s=function(e){for(var t=y.length-1;0<=t&&null!=e;--t){var n=y[t],r=n.extension.outgoing;U(r)&&(e=void 0===(n=H(n.extension,r,n.name,e,!0))?e:n)}return e}(s))?(s.id=a,t[o]=s):(delete w[a],t.splice(o--,1))}0!==t.length&&(i=u.getURL(),I.appendMessageTypeToURL&&(i.match(/\/$/)||(i+="/"),r&&(i+=r)),e={url:i,sync:e,messages:t,onSuccess:function(e){try{E.call(u,e)}catch(e){u._info("Exception during handling of messages",e)}},onFailure:function(e,t,n){try{var r=u.getTransport();n.connectionType=r?r.getType():"unknown",R.call(u,e,t,n)}catch(e){u._info("Exception during handling of failure",e)}}},u._debug("Send",e),c.send(e,n))}function z(e){0<f||!0===g?d.push(e):V(!1,[e],!1)}function $(){b=0}function G(){var e=d;d=[],0<e.length&&V(!1,e,!1)}function K(e){N("connecting"),Z(function(){var e;P()||(e={id:j(),channel:"/meta/connect",connectionType:c.getType()},_||(e.advice={timeout:0}),N("connecting"),u._debug("Connect sent",e),V(!1,[e],!0,"connect"),N("connected"))},e)}function Q(e){e&&(T=u._mixin(!1,{},I.advice,e),u._debug("New advice",T))}function Y(e){J(),e&&c&&c.abort(),h=null,N("disconnected"),$(),c=null,_=k=!1,(f=0)<d.length&&(e=d,d=[],R.call(u,void 0,e,{reason:"Disconnected"}))}function ee(e,t,n){var r=u.onTransportException;if(U(r)){u._debug("Invoking transport exception handler",e,t,n);try{r.call(u,n,e,t)}catch(e){u._info("Exception during execution of transport exception handler",e)}}}function te(e,t){U(e)&&(t=e,e=void 0),h=null,M(),P()&&l.reset(!0),Q({}),g=!(f=0),o=e,s=t;var n="1.0",r=u.getURL(),i=l.findTransportTypes(n,a,r),e={id:j(),version:n,minimumVersion:n,channel:"/meta/handshake",supportedConnectionTypes:i,advice:{timeout:T.timeout,interval:T.interval}},e=u._mixin(!1,{},o,e);if(u._putCallback(e.id,t),!c&&!(c=l.negotiateTransport(i,n,a,r))){r="Could not find initial transport among: "+l.getTransportTypes();throw u._warn(r),new Error(r)}u._debug("Initial transport is",c.getType()),N("handshaking"),u._debug("Handshake sent",e),V(!1,[e],!1,"handshake")}function ne(t,n){try{t.call(u,n)}catch(e){t=u.onCallbackException;if(U(t)){u._debug("Invoking callback exception handler",e);try{t.call(u,e,n)}catch(e){u._info("Exception during execution of callback exception handler",e)}}else u._info("Exception during execution of message callback",e)}}function re(e){var t=u._getCallback([e.id]);U(t)&&(delete w[e.id],ne(t,e))}function ie(e){var t=x[e.id];if(delete x[e.id],t){u._debug("Handling remote call response for",e,"with context",t);var n=t.timeout;n&&ve.clearTimeout(n);t=t.callback;if(U(t))return ne(t,e),1}}function oe(e){u._debug("Transport failure handling",e),e.transport&&(c=e.transport),e.url&&c.setURL(e.url);var t,n=e.action,r=e.delay||0;switch(n){case"handshake":t=r,N("handshaking"),g=!0,Z(function(){te(o,s)},t);break;case"retry":K(r);break;case"none":Y(!0);break;default:throw new Error("Unknown action "+n)}}function se(e,t){re(e),X("/meta/handshake",e),X("/meta/unsuccessful",e),P()&&(t.action="none"),u.onTransportFailure.call(u,e,t,oe)}function ae(e,t){X("/meta/connect",e),X("/meta/unsuccessful",e),P()&&(t.action="none"),u.onTransportFailure.call(u,e,t,oe)}function ce(e){Y(!0),re(e),X("/meta/disconnect",e),X("/meta/unsuccessful",e)}function ue(e){var t,n=m[e.subscription];if(n)for(var r in n)!n.hasOwnProperty(r)||(t=n[r])&&!t.listener&&(delete n[r],u._debug("Removed failed subscription",t));re(e),X("/meta/subscribe",e),X("/meta/unsuccessful",e)}function le(e){re(e),X("/meta/unsubscribe",e),X("/meta/unsuccessful",e)}function he(e){ie(e)||(re(e),X("/meta/publish",e),X("/meta/unsuccessful",e))}function fe(e){var t,n;if(C=0,null!=(e=function(e){for(var t=0;t<y.length&&null!=e;++t){var n=y[t],r=n.extension.incoming;U(r)&&(e=void 0===(n=H(n.extension,r,n.name,e,!1))?e:n)}return e}(e)))switch(Q(e.advice),e.channel){case"/meta/handshake":!function(e){var t=u.getURL();if(e.successful){var n=u._isCrossDomain(F(t)[2]),t=l.negotiateTransport(e.supportedConnectionTypes,e.version,n,t);if(null===t)return e.successful=!1,se(e,{cause:"negotiation",action:"none",transport:null});c!==t&&(u._debug("Transport",c&&c.getType(),"->",t.getType()),c=t),h=e.clientId,g=!1,G(),e.reestablish=k,k=!0,re(e),X("/meta/handshake",e),S=e["x-messages"]||0;var r=P()?"none":T.reconnect||"retry";switch(r){case"retry":$(),0===S?K(0):u._debug("Processing",S,"handshake-delivered messages");break;case"none":Y(!0);break;default:throw new Error("Unrecognized advice action "+r)}}else se(e,{cause:"unsuccessful",action:T.reconnect||"handshake",transport:c})}(e);break;case"/meta/connect":!function(e){if(_=e.successful){X("/meta/connect",e);var t=P()?"none":T.reconnect||"retry";switch(t){case"retry":$(),K(b);break;case"none":Y(!1);break;default:throw new Error("Unrecognized advice action "+t)}}else ae(e,{cause:"unsuccessful",action:T.reconnect||"retry",transport:c})}(e);break;case"/meta/disconnect":(n=e).successful?(Y(!1),re(n),X("/meta/disconnect",n)):ce(n);break;case"/meta/subscribe":(n=e).successful?(re(n),X("/meta/subscribe",n)):ue(n);break;case"/meta/unsubscribe":(t=e).successful?(re(t),X("/meta/unsubscribe",t)):le(t);break;default:void 0!==(t=e).data?ie(t)||(X(t.channel,t),0<S&&0===--S&&(u._debug("Processed last handshake-delivered message"),K(0))):void 0===t.successful?u._warn("Unknown Bayeux Message",t):t.successful?(re(t),X("/meta/publish",t)):he(t)}}function de(e){var t=m[e];if(t)for(var n in t)if(t.hasOwnProperty(n)&&t[n])return 1}function ge(e,t){var n={scope:e,method:t};if(U(e))n.scope=void 0,n.method=e;else if(A(t)){if(!e)throw new Error("Invalid scope "+e);if(n.method=e[t],!U(n.method))throw new Error("Invalid callback "+t+" for scope "+e)}else if(!U(t))throw new Error("Invalid callback "+t);return n}function pe(e,t,n,r){var i=ge(t,n);u._debug("Adding",r?"listener":"subscription","on",e,"with scope",i.scope,"and callback",i.method);t=++p,n={id:t,channel:e,scope:i.scope,callback:i.method,listener:r},i=m[e];return i||(m[e]=i={}),i[t]=n,u._debug("Added",r?"listener":"subscription",n),n}this._mixin=function(e,t,n){for(var r=t||{},i=2;i<arguments.length;++i){var o,s,a=arguments[i];if(null!=a)for(var c in a)a.hasOwnProperty(c)&&(o=L(a,c),s=L(r,c),o!==t&&void 0!==o&&(e&&"object"==typeof o&&null!==o?o instanceof Array?r[c]=this._mixin(e,s instanceof Array?s:[],o):(s="object"!=typeof s||s instanceof Array?{}:s,r[c]=this._mixin(e,s,o)):r[c]=o))}return r},this._warn=function(){D("warn",arguments)},this._info=function(){"warn"!==I.logLevel&&D("info",arguments)},this._debug=function(){"debug"===I.logLevel&&D("debug",arguments)},this._isCrossDomain=function(e){return!!(be.location&&be.location.host&&e)&&e!==be.location.host},this.send=z,this._getCallback=function(e){return w[e]},this._putCallback=function(e,t){var n=this._getCallback(e);return U(t)&&(w[e]=t),n},this.onTransportFailure=function(e,t,n){this._debug("Transport failure",t,"for",e);var r,i=this.getTransportRegistry(),o=this.getURL(),s=this._isCrossDomain(F(o)[2]),a=i.findTransportTypes("1.0",s,o);"none"===t.action?"/meta/handshake"===e.channel&&(t.transport||(r="Could not negotiate transport, client=["+a+"], server=["+e.supportedConnectionTypes+"]",this._warn(r),c&&ee(c.getType(),null,{reason:r,connectionType:c.getType(),transport:c}))):(t.delay=this.getBackoffPeriod(),"/meta/handshake"===e.channel?(t.transport||((o=i.negotiateTransport(a,"1.0",s,o))?(c&&(this._debug("Transport",c.getType(),"->",o.getType()),ee(c.getType(),o.getType(),e.failure)),t.action="handshake",t.transport=o):(this._warn("Could not negotiate transport, client=["+a+"]"),c&&ee(c.getType(),null,e.failure),t.action="none")),"none"!==t.action&&this.increaseBackoffPeriod()):(a=(new Date).getTime(),0===C&&(C=a),"retry"===t.action&&(t.delay=this.increaseBackoffPeriod(),0<(e=T.maxInterval)&&T.timeout+T.interval+e<a-C+b&&(t.action="handshake")),"handshake"===t.action&&(t.delay=0,i.reset(!1),this.resetBackoffPeriod()))),n.call(u,t)},this.receive=fe,E=function(e){u._debug("Received",e);for(var t=0;t<e.length;++t)fe(e[t])},R=function(e,t,n){u._debug("handleFailure",e,t,n),n.transport=e;for(var r=0;r<t.length;++r){var i=t[r],o={id:i.id,successful:!1,channel:i.channel,failure:n};switch((n.message=i).channel){case"/meta/handshake":se(o,{cause:"failure",action:"handshake",transport:null});break;case"/meta/connect":_=!1,ae(o,{cause:"failure",action:"retry",transport:null});break;case"/meta/disconnect":ce(o);break;case"/meta/subscribe":o.subscription=i.subscription,ue(o);break;case"/meta/unsubscribe":o.subscription=i.subscription,le(o);break;default:he(o)}}},this.registerTransport=function(e,t,n){n=l.add(e,t,n);return n&&(this._debug("Registered transport",e),U(t.registered)&&t.registered(e,this)),n},this.unregisterTransport=function(e){var t=l.remove(e);return null!==t&&(this._debug("Unregistered transport",e),U(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){l.clear()},this.getTransportTypes=function(){return l.getTransportTypes()},this.findTransport=function(e){return l.find(e)},this.getTransportRegistry=function(){return l},this.configure=function(e){!function(e){if(u._debug("Configuring cometd object with",e),A(e)&&(e={url:e}),I=u._mixin(!1,I,e=e||{}),!(t=u.getURL()))throw new Error("Missing required configuration parameter 'url' specifying the Bayeux server URL");var e=(n=F(t))[2],t=n[8],n=n[9];a=u._isCrossDomain(e),I.appendMessageTypeToURL&&(void 0!==n&&0<n.length?(u._info("Appending message type to URI "+t+n+" is not supported, disabling 'appendMessageTypeToURL' configuration"),I.appendMessageTypeToURL=!1):(n=(e=t.split("/")).length-1,t.match(/\/$/)&&--n,0<=e[n].indexOf(".")&&(u._info("Appending message type to URI "+t+" is not supported, disabling 'appendMessageTypeToURL' configuration"),I.appendMessageTypeToURL=!1)))}.call(this,e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e,t){if("disconnected"!==r)throw new Error("Illegal state: handshaken");te(e,t)},this.disconnect=function(e,t,n){var r;P()?n&&n():("boolean"!=typeof e&&(n=t,t=e,e=!1),U(t)&&(n=t,t=void 0),r={id:j(),channel:"/meta/disconnect"},r=this._mixin(!1,{},t,r),u._putCallback(r.id,n),N("disconnecting"),V(!0===e,[r],!1,"disconnect"))},this.startBatch=function(){++f,u._debug("Starting batch, depth",f)},this.endBatch=function(){!function(){if(--f,u._debug("Ending batch, depth",f),f<0)throw new Error("Calls to startBatch() and endBatch() are not paired");0!==f||P()||g||G()}()},this.batch=function(e,t){t=ge(e,t);this.startBatch();try{t.method.call(t.scope),this.endBatch()}catch(e){throw this._info("Exception during execution of batch",e),this.endBatch(),new Error(e)}},this.addListener=function(e,t,n){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: channel must be a string");return pe(e,t,n,!0)},this.removeListener=function(e){if(!(e&&e.channel&&"id"in e))throw new Error("Invalid argument: expected subscription, not "+e);B(e)},this.clearListeners=function(){m={}},this.subscribe=function(e,t,n,r,i){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: channel must be a string");if(P())throw new Error("Illegal state: disconnected");U(t)&&(i=r,r=n,n=t,t=void 0),U(r)&&(i=r,r=void 0);var o=!de(e),s=pe(e,t,n,!1);return o&&(o={id:j(),channel:"/meta/subscribe",subscription:e},o=this._mixin(!1,{},r,o),u._putCallback(o.id,i),z(o)),s},this.unsubscribe=function(e,t,n){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(P())throw new Error("Illegal state: disconnected");U(t)&&(n=t,t=void 0),this.removeListener(e);var r=e.channel;de(r)||(r={id:j(),channel:"/meta/unsubscribe",subscription:r},r=this._mixin(!1,{},t,r),u._putCallback(r.id,n),z(r))},this.resubscribe=function(e,t){if(O(e),e)return this.subscribe(e.channel,e.scope,e.callback,t)},this.clearSubscriptions=function(){M()},this.publish=function(e,t,n,r){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: channel must be a string");if(/^\/meta\//.test(e))throw new Error("Illegal argument: cannot publish to meta channels");if(P())throw new Error("Illegal state: disconnected");U(t)?(r=t,t={},n=void 0):U(n)&&(r=n,n=void 0);var i={id:j(),channel:e,data:t},i=this._mixin(!1,{},n,i);u._putCallback(i.id,r),z(i)},this.publishBinary=function(e,t,n,r,i){U(t)?(i=t,t=new ArrayBuffer(0),n=!0,r=void 0):U(n)?(i=n,n=!0,r=void 0):U(r)&&(i=r,r=void 0);this.publish(e,{meta:r,data:t,last:n},{ext:{binary:{}}},i)},this.remoteCall=function(e,t,n,r,i){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: target must be a string");if(P())throw new Error("Illegal state: disconnected");if(U(t)?(i=t,t={},n=I.maxNetworkDelay,r=void 0):U(n)?(i=n,n=I.maxNetworkDelay,r=void 0):U(r)&&(i=r,r=void 0),"number"!=typeof n)throw new Error("Illegal argument type: timeout must be a number");e.match(/^\//)||(e="/"+e);var o={id:j(),channel:"/service"+e,data:t},s=this._mixin(!1,{},r,o),o={callback:i};0<n&&(o.timeout=ve.setTimeout(u,function(){u._debug("Timing out remote call",s,"after",n,"ms"),he({id:s.id,error:"406::timeout",successful:!1,failure:{message:s,reason:"Remote Call Timeout"}})},n),u._debug("Scheduled remote call timeout",s,"in",n,"ms")),x[s.id]=o,z(s)},this.remoteCallBinary=function(e,t,n,r,i,o){U(t)?(o=t,t=new ArrayBuffer(0),n=!0,r=void 0,i=I.maxNetworkDelay):U(n)?(o=n,n=!0,r=void 0,i=I.maxNetworkDelay):U(r)?(o=r,r=void 0,i=I.maxNetworkDelay):U(i)&&(o=i,i=I.maxNetworkDelay);this.remoteCall(e,{meta:r,data:t,last:n},i,{ext:{binary:{}}},o)},this.getStatus=function(){return r},this.isDisconnected=P,this.setBackoffIncrement=function(e){I.backoffIncrement=e},this.getBackoffIncrement=function(){return I.backoffIncrement},this.getBackoffPeriod=function(){return b},this.increaseBackoffPeriod=function(){return b<I.maxBackoff&&(b+=I.backoffIncrement),b},this.resetBackoffPeriod=function(){$()},this.setLogLevel=function(e){I.logLevel=e},this.registerExtension=function(e,t){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: extension name must be a string");for(var n=!1,r=0;r<y.length;++r)if(y[r].name===e){n=!0;break}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(y.push({name:e,extension:t}),this._debug("Registered extension",e),U(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!A(e))throw new Error("Illegal argument type: extension name must be a string");for(var t=!1,n=0;n<y.length;++n){var r=y[n];if(r.name===e){y.splice(n,1),t=!0,this._debug("Unregistered extension",e);r=r.extension;U(r.unregistered)&&r.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;t<y.length;++t){var n=y[t];if(n.name===e)return n.extension}return null},this.getName=function(){return n},this.getClientId=function(){return h},this.getURL=function(){if(c){var e=c.getURL();if(e)return e;if(e=I.urls[c.getType()])return e}return I.url},this.getTransport=function(){return c},this.getConfiguration=function(){return this._mixin(!0,{},I)},this.getAdvice=function(){return this._mixin(!0,{},T)},t&&t.noDefaultTransports||(be.WebSocket&&this.registerTransport("websocket",new we),this.registerTransport("long-polling",new ye),this.registerTransport("callback-polling",new Te))},Transport:m,RequestTransport:n,LongPollingTransport:ye,CallbackPollingTransport:Te,WebSocketTransport:we,Utils:ve,Z85:{encode:function(e){var t=null;if(e instanceof ArrayBuffer?t=e:e.buffer instanceof ArrayBuffer?t=e.buffer:Array.isArray(e)&&(t=new Uint8Array(e).buffer),null==t)throw new Error("Cannot Z85 encode "+e);for(var n=t.byteLength,e=n%4,r=4-(0==e?4:e),i=new DataView(t),o="",s=0,a=0;a<n+r;++a){var c=n<=a,s=256*s+(c?0:i.getUint8(a));if((a+1)%4==0){for(var u,l=52200625,h=5;0<h;--h)(!c||r<h)&&(u=Math.floor(s/l)%85,o+=f[u]),l/=85;s=0}}return o},decode:function(e){for(var t=e.length%5,n=5-(0==t?5:t),r=0;r<n;++r)e+=f[f.length-1];for(var i=e.length,t=new ArrayBuffer(4*i/5-n),o=new DataView(t),s=0,a=0,c=0,u=0;u<i;++u){var l=e.charCodeAt(a++)-32,s=85*s+d[l];if(a%5==0){for(var h=16777216;1<=h;)c<o.byteLength&&o.setUint8(c++,Math.floor(s/h)%256),h/=256;s=0}}return t}}}},"function"==typeof n&&n.amd?n([],t):(e.org=e.org||{},e.org.cometd=t()),e=this,t=function(e){return e.AckExtension=function(){var n,o,s=!1;function a(e,t){n._debug(e,t)}this.registered=function(e,t){n=t,a("AckExtension: executing registration callback")},this.unregistered=function(){a("AckExtension: executing unregistration callback"),n=null},this.incoming=function(e){var t,n,r=e.channel,i=e.ext;return"/meta/handshake"===r?(i&&("object"==typeof(t=i.ack)?(s=!0===t.enabled,"number"==typeof(n=t.batch)&&(o=n)):s=!0===t),a("AckExtension: server supports acknowledgements",s)):"/meta/connect"===r&&e.successful&&s&&i&&"number"==typeof i.ack&&a("AckExtension: server sent batch",o=i.ack),e},this.outgoing=function(e){var t=e.channel;return e.ext||(e.ext={}),"/meta/handshake"===t?(e.ext.ack=n&&!1!==n.ackEnabled,s=!1,o=0):"/meta/connect"===t&&s&&a("AckExtension: client sending batch",e.ext.ack=o),e}}},"function"==typeof n&&n.amd?n(["./cometd"],t):t(e.org.cometd),t=this,e=function(r){return r.TimeSyncExtension=function(e){var n,a=e&&e.maxSamples||10,c=[],u=[],l=0,h=0;function f(e,t){n._debug(e,t)}this.registered=function(e,t){n=t,f("TimeSyncExtension: executing registration callback")},this.unregistered=function(){f("TimeSyncExtension: executing unregistration callback"),n=null,c=[],u=[]},this.incoming=function(e){var t=e.channel;if(t&&0===t.indexOf("/meta/")&&e.ext&&e.ext.timesync){var n=e.ext.timesync;f("TimeSyncExtension: server sent timesync",n);t=((new Date).getTime()-n.tc-n.p)/2,n=n.ts-n.tc-t;c.push(t),u.push(n),u.length>a&&(u.shift(),c.shift());for(var r=u.length,i=0,o=0,s=0;s<r;++s)i+=c[s],o+=u[s];l=parseInt((i/r).toFixed()),h=parseInt((o/r).toFixed()),f("TimeSyncExtension: network lag",l)}return e},this.outgoing=function(e){var t=e.channel;return t&&0===t.indexOf("/meta/")&&(e.ext||(e.ext={}),e.ext.timesync={tc:(new Date).getTime(),l:l,o:h},f("TimeSyncExtension: client sending timesync",e.ext.timesync)),e},this.getTimeOffset=function(){return h},this.getTimeOffsetSamples=function(){return u},this.getNetworkLag=function(){return l},this.getServerTime=function(){return(new Date).getTime()+h},this.getServerDate=function(){return new Date(this.getServerTime())},this.setTimeout=function(e,t){t=(t instanceof Date?t.getTime():0+t)-h-(new Date).getTime();return r.Utils.setTimeout(n,e,t=t<=0?1:t)}}},"function"==typeof n&&n.amd?n(["./cometd"],e):e(t.org.cometd),e=this,t=function(n){return n.BinaryExtension=function(){this.incoming=function(e){var t;return/^\/meta\//.test(e.channel)||(t=e.ext)&&t.binary&&(e.data.data=n.Z85.decode(e.data.data)),e},this.outgoing=function(e){var t;return/^\/meta\//.test(e.channel)||(t=e.ext)&&t.binary&&(e.data.data=n.Z85.encode(e.data.data)),e}}},"function"==typeof n&&n.amd?n(["./cometd"],t):t(e.org.cometd),org.cometd});